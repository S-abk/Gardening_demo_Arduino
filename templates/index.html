<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Garden Monitor</title>
    <script src="https://cdn.socket.io/5.3.6/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .sensor-data { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Garden Monitor</h1>
    <div class="sensor-data">
        <p>Temperature: <span id="temperature">0.00</span> °C</p>
        <p>Humidity: <span id="humidity">0.00</span> %</p>
        <p>Moisture: <span id="moisture">0</span></p>
        <p id="watering-status">Watering Status: Off</p>
        <button onclick="toggleWatering()">Toggle Watering</button>
    </div>
    <canvas id="sensorChart" width="400" height="200"></canvas>
    <script>
        let updateTimeout; // Timeout for the next update
        const updateInterval = 5000; // Process updates every 5 seconds    
        const socket = io();
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const sensorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Time labels
                datasets: [{
                    label: 'Temperature (°C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    fill: false
                }, {
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    }
                }
            }
        });

        socket.on('sensor_update', function(data) {
        if (updateTimeout) clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            document.getElementById('temperature').innerText = data.temperature.toFixed(2);
            document.getElementById('humidity').innerText = data.humidity.toFixed(2);
            document.getElementById('moisture').innerText = data.moisture;
            document.getElementById('watering-status').innerText = data.watering_status ? 'On' : 'Off';

            // Update chart
            const currentTime = new Date();
            sensorChart.data.labels.push(currentTime);
            sensorChart.data.datasets[0].data.push(data.temperature);
            sensorChart.data.datasets[1].data.push(data.humidity);

            // Keep only the last 10 minutes of data
            if (sensorChart.data.labels.length > 10) {
                sensorChart.data.labels.shift();
                sensorChart.data.datasets[0].data.shift();
                sensorChart.data.datasets[1].data.shift();
            }
            sensorChart.update();
        }, updateInterval);
    });

        async function toggleWatering() {
            const response = await fetch('/toggle_watering', { method: 'POST' });
            const result = await response.json();
            document.getElementById('watering-status').innerText = result.status;
        }
    </script>
</body>
</html>
